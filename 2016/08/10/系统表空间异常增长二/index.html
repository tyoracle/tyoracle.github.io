<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>SYSTEM表空间异常增长问题分析（二） | IT 职业生涯规划</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="继续分析又一个周未过去了，但是在周未的时候，系统再次报错，在system表空间已扩展到32G的情况下，逼不得已再把system表空间再扩充了64G。这样下去不是办法啊，必须要想出一个彻底解决的方案。
检查hisgram$这个表，发现已增长了一千多万
 
SQL&amp;gt; select count(*) from histgrm$;            

  COUNT(*)            
-">
<meta property="og:type" content="article">
<meta property="og:title" content="SYSTEM表空间异常增长问题分析（二）">
<meta property="og:url" content="http://tyoracle.com/2016/08/10/系统表空间异常增长二/index.html">
<meta property="og:site_name" content="IT 职业生涯规划">
<meta property="og:description" content="继续分析又一个周未过去了，但是在周未的时候，系统再次报错，在system表空间已扩展到32G的情况下，逼不得已再把system表空间再扩充了64G。这样下去不是办法啊，必须要想出一个彻底解决的方案。
检查hisgram$这个表，发现已增长了一千多万
 
SQL&amp;gt; select count(*) from histgrm$;            

  COUNT(*)            
-">
<meta property="og:updated_time" content="2017-02-03T08:40:52.517Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SYSTEM表空间异常增长问题分析（二）">
<meta name="twitter:description" content="继续分析又一个周未过去了，但是在周未的时候，系统再次报错，在system表空间已扩展到32G的情况下，逼不得已再把system表空间再扩充了64G。这样下去不是办法啊，必须要想出一个彻底解决的方案。
检查hisgram$这个表，发现已增长了一千多万
 
SQL&amp;gt; select count(*) from histgrm$;            

  COUNT(*)            
-">
  
    <link rel="alternate" href="/atom.xml" title="IT 职业生涯规划" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">IT 职业生涯规划</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">时间的朋友</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://tyoracle.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-系统表空间异常增长二" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/10/系统表空间异常增长二/" class="article-date">
  <time datetime="2016-08-09T16:00:00.000Z" itemprop="datePublished">2016-08-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/oracle/">oracle</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      SYSTEM表空间异常增长问题分析（二）
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="继续分析"><a href="#继续分析" class="headerlink" title="继续分析"></a>继续分析</h1><p>又一个周未过去了，但是在周未的时候，系统再次报错，在system表空间已扩展到32G的情况下，逼不得已再把system表空间再扩充了64G。这样下去不是办法啊，必须要想出一个彻底解决的方案。</p>
<p>检查hisgram$这个表，发现已增长了一千多万</p>
<pre><code> 
SQL> select count(*) from histgrm$;            

  COUNT(*)            
----------            
17679019

</code></pre>

<p>检查这个表占用最多的是那些表的柱状图统计信息</p>
<pre><code> 

Table    count(*)        partitions 
F_XXXXX_DDDDDDDDDD_H    187883        1500  <<<------ 33="" 62="" 1907="" 10176="" 12073="" 12821="" 12877="" 12878="" 13190="" 14825="" 16040="" 16555="" 17268="" 17673="" 17804="" 23433="" 65124="" 77148="" f_xx_ddddd_ggggg_vvvv_h="" <<<------="" a_d_xxx_xxxx_ddu="" f_ag_loan_cont_s="" f_ag_loan_apl_msg_s="" f_ag_elec_acpt_dra_s="" f_as_guar_msg_s="" f_pt_cred_org_pt_msg_s="" f_ev_in_lend_buss_s="" f_ev_exp_bar_trad_s="" f_ev_loan_out_acc_msg_s="" f_ev_remit_fund_trad_s="" f_ev_imp_arr_ord_trad_s="" f_ev_abch_rem_fud_trad_s="" f_ev_cbill_coll_trad_s="" f_ev_online_aut_orig_s="" <="" code=""></------></code></pre>        

<p>前面三个表的记录数最多，特别是前面两个，每个表的分区数一千多个，所以每收集一次统计信息，就会增加非常多的记录，所以system 表空间消耗得特别快。</p>
<p>既然知道是因为柱状图的收集而引起的，那柱状图的作用是什么呢？当系统中的某些表存在高度不均匀的数据分布时，使用柱状图能够产生更好的选择性评估，从而产生更加优化的执行计划，如判定是选择走索引好还是走全表好。其实这对于普通的ORACLE数据库是非常好的特性，因为使用索引，能提高普通ORACLE数据库的性能，但我们现在的环境则相反，我们现在是EXADATA，在EXADATA里，通常建议是尽量减少索引，利用EXADATA的storage index特性能提高SQL的性能，使用普通的btree索引，反而性能会下降得厉害。正因为此，这些业务表上，除了主键外，都没有索引，因此，柱状图对于exadata的环境是没有什么用处的。</p>
<p>既然知道了原理，那我们就明白，histgrm$的异常增长，柱状图的收集，不会给我们的系统带来任何的好处，那我们为什么还要收集它呢？</p>
<p>检查系统当前的统计信息收集策略</p>
<pre><code> 
SQL> select client_name,status from dba_autotask_client;                 

CLIENT_NAME                                                      STATUS  
/-------------------------------------------------------------- /--------
auto optimizer stats collection                                  ENABLED 
auto space advisor                                               ENABLED 
sql tuning advisor                                               ENABLED 
</code></pre>    

<p>当前是系统默认的自动收集，即表的数据量变化达到了表的大小10%时，即会自动收集统计信息。而这个自动收集统计信息的功能，其同时也会自动收集柱状图的相关信息，正因为这样，才会导致每个周未，system表空间都异常增长，原因就是周未的时候，作了自动的统计信息收集。</p>
<pre><code> 
select dbms_stats.get_prefs('method_opt') from dual;
DBMS_STATS.GET_PREFS('METHOD_OPT')
/-------------------------------------------------------------------------------
FOR ALL COLUMNS SIZE AUTO

</code></pre>    

<p>从上面的查询中就可以看到当前自动收集是打开了柱状图的自动收集功能的。我们也可以单独查询上述最大的那三张表是不是也是打开了柱状图的自动收集功能的。</p>
<pre><code> 
SQL> select dbms_stats.get_prefs('method_opt','DWUSR','F_XXXXX_DDDDDDDDDD_H') from dual;

DBMS_STATS.GET_PREFS('METHOD_OPT','DWUSR','F_XXXXX_DDDDDDDDDD_H')
/--------------------------------------------------------------------------------
FOR ALL COLUMNS SIZE AUTO


SQL> select dbms_stats.get_prefs('method_opt','DWUSR','F_XX_DDDDD_GGGGG_VVVV_H') from dual;

DBMS_STATS.GET_PREFS('METHOD_OPT','DWUSR','F_XX_DDDDD_GGGGG_VVVV_H')
/--------------------------------------------------------------------------------
FOR ALL COLUMNS SIZE AUTO



SQL> select dbms_stats.get_prefs('method_opt','DWUSR','A_D_XXX_XXXX_DDU') from dual;

DBMS_STATS.GET_PREFS('METHOD_OPT','DWUSR','A_D_XXX_XXXX_DDU')
/--------------------------------------------------------------------------------
FOR ALL COLUMNS SIZE AUTO

</code></pre>    

<p>从上述的结果更加确信了上述的推测，现在我们要验证的是，不收集这个柱状图统计信息，这个histgrm$基表是不是就不会停止增长了。我们取三个表中最小的那个表A_D_XXX_XXXX_DDU进行试验。</p>
<pre><code> 
SQL>   exec dbms_stats.DELETE_TABLE_STATS(OWNNAME=> 'DWUSR',TABNAME=>'A_D_XXX_XXXX_DDU');   

PL/SQL procedure successfully completed.

我们先删除了这个表的统计信息

SQL> select count(*) from histgrm$ a where a.obj# in (select b.object_id from dba_objects b where b.object_name='A_D_XXX_XXXX_DDU');

  COUNT(*)
/----------
         0
删除后，在histgrm$里就没有这个表的相关信息了，histgrm$的空间就可以被重用了。但因为是数据字典表，这个空出来的空间不能被回收，只能被另外的记录重用。

</code></pre>


<p>我们重新以不收集柱状图的方式重新收集这个表的信息，指定</p>
<p>METHOD_OPT=&gt;’for all columns size 1’</p>
<pre><code> 
15:20:53 SQL> exec dbms_stats.GATHER_TABLE_STATS(OWNNAME=> 'DWUSR',TABNAME=>'A_D_XXX_XXXX_DDU',ESTIMATE_PERCENT=>dbms_stats.auto_sample_size,METHOD_OPT=>'for all columns size 1') ;

PL/SQL procedure successfully completed.

Elapsed: 00:34:35.72

15:55:31 SQL>                   select count(*) from histgrm$ a where a.obj# in (select b.object_id from dba_objects b where b.object_name='A_D_XXX_XXXX_DDU');

  COUNT(*)
----------
         0

Elapsed: 00:00:00.03    

</code></pre>

<p>收集完成后，我们检查histgrm$，果然如我们所期望的一样，没有任何的记录，即在不收集柱状图的情况下，这个histgrm$基表是不会增长的。</p>
<p>OK，那我们验证成功了，既然这个柱状图对exadata 环境没什么用，那我们就把全库的柱状图都禁止好了，进行以下的设置</p>
<pre><code> 
16:14:22 SQL>      exec dbms_stats.set_param(pname=>'METHOD_OPT',pval=>'FOR ALL COLUMNS SIZE 1');

PL/SQL procedure successfully completed.

Elapsed: 00:00:00.04
16:19:57 SQL> select dbms_stats.get_prefs('method_opt') from dual;

DBMS_STATS.GET_PREFS('METHOD_OPT')
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
FOR ALL COLUMNS SIZE 1

全库的统计信息收集属性改变了，不收集柱状图的信息

Elapsed: 00:00:00.00
16:20:11 SQL> select dbms_stats.get_prefs('method_opt','DWUSR','F_XXXXX_DDDDDDDDDD_H') from dual;

DBMS_STATS.GET_PREFS('METHOD_OPT','DWUSR','F_XXXXX_DDDDDDDDDD_H')
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
FOR ALL COLUMNS SIZE 1

Elapsed: 00:00:00.00
16:20:25 SQL> 
对应的表的收集属性也跟着变化了
</code></pre>

<p>至此问题得到完美的解决，SYSTEM表空间再不会因为histgrm$这个表的异常增长而撑爆。但是，如果在非EXADATA的环境，并且表字段的数据分布不均的情况下，柱状图还是非常有用的，这样 histgrm$增长就在所难免了。解决问题，只要知道了其原理，具体问题具体分析，一般都能找到解决方案。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tyoracle.com/2016/08/10/系统表空间异常增长二/" data-id="ciz2eyk9n00080oo5mc6cg6pf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/oracle-11-2-0-4/">oracle,11.2.0.4</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/08/30/运营商异常缓慢的SQL优化/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          运营商异常缓慢SQL优化
        
      </div>
    </a>
  
  
    <a href="/2016/08/02/系统参数设置不当导致ORACLE坏块的故事/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">系统参数设置不当导致ORACLE坏块的故事</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Pelican/">Pelican</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/oracle/">oracle</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/">Mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python-Pelican-GitHub-Markdown/">Python, Pelican, GitHub, Markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oracle-troubleshooting/">oracle ,troubleshooting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oracle-11-2-0-4/">oracle,11.2.0.4</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oracle-sql-tuning/">oracle,sql tuning</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/Python-Pelican-GitHub-Markdown/" style="font-size: 10px;">Python, Pelican, GitHub, Markdown</a> <a href="/tags/oracle-troubleshooting/" style="font-size: 10px;">oracle ,troubleshooting</a> <a href="/tags/oracle-11-2-0-4/" style="font-size: 20px;">oracle,11.2.0.4</a> <a href="/tags/oracle-sql-tuning/" style="font-size: 10px;">oracle,sql tuning</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/02/06/该奋斗了/">该奋斗了</a>
          </li>
        
          <li>
            <a href="/2017/01/03/2017_new_begining/">2017_new_begining</a>
          </li>
        
          <li>
            <a href="/2016/10/09/PMON_unable_to_acquire_latch的问题分析/">PMON unable to acquire latch的问题分析</a>
          </li>
        
          <li>
            <a href="/2016/09/30/JDBC参数导致大量的library cache lock/">JDBC参数导致大量的library cache lock</a>
          </li>
        
          <li>
            <a href="/2016/09/28/mysql的CVE-2016-6662安全漏洞/">mysql的CVE-2016-6662安全漏洞修复</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 TY<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>